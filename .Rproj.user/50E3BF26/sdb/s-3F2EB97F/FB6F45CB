{
    "contents" : "# process phenotype for Natalia #\n\n###### CONSTANTS\nMAF=0.05\n\n#### Read genotype sample names\ngeno.samples <- read.table(\"genotyped.samples.txt\", as.is=TRUE)\nnames(geno.samples) <- c(\"id\")\n\n#### Read phenotype file\npheno     <- read.table(\"pheno.noHeader.txt\", as.is=TRUE)\npheno.names <- read.table(\"pheno.names.txt\", skip=1, as.is=T)[,2]\nnames(pheno) <- pheno.names\n\n#### Generate the phenotype data for all samples with genotypes\npheno.allgeno <- merge(geno.samples, pheno, all.x=TRUE)\nwrite.table(pheno.allgeno, file=\"phenos.allgeno.txt\", quote=FALSE, sep=\"\\t\", row.names=FALSE, col.names=FALSE)\n\n#### Read master covariate file\ncovars        <- read.table(\"cov.noHeader.txt\", sep=\"\\t\", as.is=T)\ncovar.names   <- read.table(\"cov.names.txt\", skip=1, as.is=T)[,2]\nnames(covars) <- covar.names\n\n#### Change the sex covariate to an indicator variable\ncovars$sex    <- replace(covars$sex, covars$sex == \"M\", \"0\")\ncovars$sex    <- replace(covars$sex, covars$sex == \"F\", \"1\")\ncovars$sex    <- as.numeric(covars$sex)\n\n#### Change the batch and ppi.box covariates to set of indicator variables for gemma\n#### Convert generation to factor as well.\nbatches       <- unique(covars$batch)\n#batches       <- batches[-1]\nfor (batch in batches) {\n  covars[,paste0(\"is.batch\", batch)]  <- as.integer(covars$batch == batch)\n}\nboxes         <- unique(covars$ppi.box[which(!is.na(covars$ppi.box))])\n#boxes         <- boxes[-1]\nfor (box in boxes) {\n  covars[,paste0(\"is.ppi.box\", box)] <- as.integer(covars$ppi.box == box)\n}\nboxes         <- unique(covars$cpp.box[which(!is.na(covars$cpp.box))])\n#boxes         <- boxes[-1]\nfor (box in boxes) {\n  covars[,paste0(\"is.cpp.box\", box)] <- as.integer(covars$cpp.box == box)\n}\ngens          <- unique(covars$gen)\n#gens          <- gens[-1]\nfor (gen in gens) {\n    covars[,paste0(\"is.gen\", gen)] <- as.integer(covars$gen == gen)\n}\n\n#### Make covariate file with all ids in gentype file\ncovars <- merge(geno.samples, covars, all.x=TRUE)\ncovars$one <- 1\n\n####### Code for anova testing batch having a significant explantory power on outcome\n####### and batch 13 as being different from rest of batches in terms of outcome\n#cpp8.t <- pheno$cpp8.t\n#batch <- as.factor(covars$batch)\n#anova.cpp <- anova(lm(cpp8.t~batch))\n#anova.cpp <- anova(lm(cpp8.t~covars$is.batch13))\n#anova.cpp <- anova(lm(cpp8.t~as.factor(covars$cpp.box)))\n\n### covariates for each trait #### updated by Natalia\ntraitcovs <- vector(\"list\", length=6)\nnames(traitcovs) <- c(\"cpp.diff\", \"cpp8.1\", \"ppi12\", \"ppi6\", \"ppi3\", \"habituation\")\n\ntraitcovs[[\"cpp.diff\"]]  <- list(\"one\", \"sex\", \"is.cpp.box2\", \"is.cpp.box3\", \"is.cpp.box4\", \n                                \"is.cpp.box7\", \"is.cpp.box11\", \"is.cpp.box12\") \ntraitcovs[[\"cpp8.1\"]]  <- list(\"one\", \"sex\", \"is.cpp.box2\", \"is.cpp.box3\", \"is.cpp.box4\", \n                        \"is.cpp.box8\", \"is.cpp.box10\", \"is.cpp.box11\", \"is.cpp.box12\") \n\ntraitcovs[[\"ppi3\"]] <- list(\"one\", \"sex\", \"is.ppi.box3\", \"ppi.weight\", \"is.batch4\")\ntraitcovs[[\"ppi6\"]] <- list(\"one\", \"sex\", \"is.ppi.box3\", \"is.ppi.box4\", \"ppi.weight\")\ntraitcovs[[\"ppi12\"]] <- list(\"one\", \"sex\", \"is.ppi.box3\", \"is.ppi.box4\",\"ppi.weight\", \n                            \"is.batch3\", \"is.batch4\", \"is.batch7\", \"is.batch9\")\n\ntraitcovs[[\"startle\"]] <- list(\"one\", \"sex\", \"is.ppi.box3\", \"is.ppi.box4\", \n                               \"ppi.weight\", \"is.batch2\") \ntraitcovs[[\"habituation\"]] <- list(\"one\", \"ppi.weight\") \n\n# \n# traitcovs[[\"cpp8.t\"]]  <- list(\"one\", \"sex\", \"is.gen53\", \"is.batch2\", \"is.batch10\", \"is.cpp.box1\", \"is.cpp.box2\", \"is.cpp.box3\", \"is.cpp.box4\", \"is.cpp.box6\", \"is.cpp.box7\", \"is.cpp.box8\", \"is.cpp.box9\", \"is.cpp.box10\", \"is.cpp.box11\", \"is.cpp.box12\") # gen53,56, batch 2,10,13,15,21, all except box 5 - \"is.gen56\",  \"is.batch13\", \"is.batch15\", \"is.batch21\", - removed due to no genotyped samples from these batches/gens\n# traitcovs[[\"sens\"]]    <- list(\"one\", \"sex\", \"is.gen52\", \"is.cpp.box7\", \"is.batch8\") # gen52, box7, batch 8\n# traitcovs[[\"act1.t\"]]  <- list(\"one\", \"sex\", \"is.cpp.box3\", \"is.cpp.box4\", \"is.cpp.box5\", \"is.cpp.box6\", \"is.cpp.box7\", \"is.cpp.box8\", \"is.cpp.box9\", \"is.cpp.box11\", \"is.cpp.box12\")#, \"is.batch14\") # box3-9,11,12, batch 14 - removed batch 14 for now due to no samples from batch 14 in genotyped samples\n# traitcovs[[\"act2.t\"]]  <- list(\"one\", \"sex\", \"is.gen52\", \"is.cpp.box5\", \"is.cpp.box7\", \"is.cpp.box8\", \"is.cpp.box10\", \"is.cpp.box12\", \"is.batch8\") # gen52,56, box5,7,8,10,12, batch 8 - removed is.gen56 as no genotyped samples\n# traitcovs[[\"act3.t\"]]  <- list(\"one\", \"sex\", \"is.cpp.box7\", \"is.cpp.box8\", \"is.cpp.box10\", \"is.cpp.box11\", \"is.cpp.box12\") # box7,8,10,11,12 - shyam removed gen and batch since which gens and batches are correlated with outcome was not mentioned in comments by natalia\n# traitcovs[[\"act4.t\"]]  <- list(\"one\", \"sex\", \"is.cpp.box7\", \"is.cpp.box8\", \"is.cpp.box11\") # box7,8,11\n# traitcovs[[\"act5.t\"]]  <- list(\"one\", \"sex\", \"is.gen51\", \"is.gen53\", \"is.cpp.box7\", \"is.cpp.box8\", \"is.batch7\") # box 7,8, gen 51,53-56, batch 7,13,15,20-22 -  \"is.gen54\", \"is.gen55\", \"is.gen56\", \"is.batch13\", \"is.batch15\", \"is.batch20\", \"is.batch21\", \"is.batch22\" - removed due to no samples from this batch / gen in genotyped data\n# traitcovs[[\"act8.t\"]]  <- list(\"one\", \"sex\", \"is.cpp.box3\", \"is.cpp.box4\", \"is.cpp.box6\", \"is.cpp.box7\", \"is.cpp.box8\", \"is.cpp.box9\", \"is.cpp.box11\", \"is.cpp.box12\", \"is.batch3\", \"is.batch7\") # box 3,4,6-9,11,12, gen56, batch 3,7 -  \"is.gen56\", removed due to no genotyped samples from gen 56\n# traitcovs[[\"avg.ppi\"]] <- list(\"one\", \"is.ppi.box3\", \"is.ppi.box4\", \"ppi.weight\", \"is.batch4\") #box 3, box4, batch4 - is sex excluded for a reason\n# traitcovs[[\"startle\"]] <- list(\"one\", \"is.ppi.box3\", \"is.ppi.box4\", \"ppi.weight\", \"is.batch2\") # box 3,4, batch 2,16,17 - is sex excluded for a reason - , \"is.batch16\", \"is.batch17\" - removed as no genotyped samples from these batches\n# traitcovs[[\"glucose\"]] <- list(\"one\", \"sex\", \"glu.weight\")\n# traitcovs[[\"wild\"]]    <- list(\"one\", \"sex\")\n\n#################### Make script to run Gemma for chosen trait ##############\nfor (trait in names(traitcovs)) {\n    index.pheno     <- which(pheno.names == trait)\n    chosen.covars   <- covars[, unlist(traitcovs[[trait]])]\n    write.table(chosen.covars, file=paste0(\"covariates/\", trait, \".covs\"), sep=\"\\t\", quote=F, row.names=F, col.names=F)\n    cmds <- (\"#! /bin/bash\\n#$ -cwd\\n#$ -j y\\n\")\n    for (chrom in 1:19) {\n        cmds <- c(cmds, paste0(\"/home/shyamg/bin/gemma -g genotypes/ail.chr\", chrom, \".filtered.dosage -p phenos.allgeno.txt -k kinship/notChr\", chrom,\".cXX.txt -a snpinfo/ail.chr\", chrom, \".snpinfo -c covariates/\", trait, \".covs -lmm 2 -maf \", MAF, \" -o \", trait, \".chr\", chrom, \" -n \", index.pheno))\n    }\n    write.table(cmds, file=paste0(\"scripts/gemma.\", trait, \".sh\"), row.names=F, col.names=F, quote=F)\n}\n\n#group.name <- \"cpp8\"\n#chosen.pheno <- c(\"cpp8.t\")\n#chosen.covars <- c(\"one\", \"sex\", paste0(\"is.cpp.box\", c(1:12)[-5]))\n#index.pheno <- sapply(chosen.pheno, function(x) { which(pheno.names == x)} )\n## Make covariate file.\n#chosen.covars <- sapply(chosen.covars, function(x) { which(names(covars) == x)} )\n#chosen.covars <- covars[, chosen.covars]\n#write.table(chosen.covars, file=paste0(\"covariates/\", group.name, \".covs\"), sep=\"\\t\", quote=F, row.names=F, col.names=F)\n\n## Run gemma chromosome wise\n#cmds <- c(\"#! /bin/bash\\n#$ -cwd\\n#$ -j y\\n\")\n#for (index in 1:length(index.pheno)) {\n#    for (chrom in 1:19) {\n#        cmds <- c(cmds, paste0(\"/home/shyamg/bin/gemma -g genotypes/ail.chr\", chrom, \".dosage -p phenosAIL.allgeno.txt -k kinship/notChr\", chrom,\".cXX.txt -a snpinfo/ail.chr\", chrom, \".snpinfo -c covariates/\", group.name, \".covs -lmm 2 #-maf \", MAF, \" -o \", chosen.pheno[index], \".chr\", chrom, \".out -n \", index.pheno[index]))\n#    }\n#    write.table(cmds, file=paste0(\"scripts/\", group.name, \".\", chosen.pheno[index], \".sh\"), row.names=F, col.names=F, quote=F)\n#}\n\n",
    "created" : 1423063998062.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2586778753",
    "id" : "FB6F45CB",
    "lastKnownWriteTime" : 1413325278,
    "path" : "C:/Users/Administrator/Desktop/Scripts/LgSm-DataProcessing/scripts/map.ail.QTL.R",
    "project_path" : "scripts/map.ail.QTL.R",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}